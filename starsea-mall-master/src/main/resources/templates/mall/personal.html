<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="mall/header::head-fragment('ä¹æ·˜ä¹å™¨å•†åŸå•†åŸ-ä¸ªäººä¸­å¿ƒ','personal')">
    <link rel="icon" href="/goods-img/lqlogo.png" type="image/png">
</head>
<link th:href="@{/mall/css/bootstrap-modal.css}" rel="stylesheet">
<link th:href="@{/mall/styles/personal.css}" rel="stylesheet">
<body>
<header th:replace="mall/header::header-fragment"></header>
<!-- nav -->
<!--<nav th:replace="mall/header::nav-fragment"></nav>-->

<!-- personal -->
<div id="personal">

    <div class="contentInfo">
        <!-- ä¸ªäººä¿¡æ¯æ¿å— -->
        <div class="profile-section">
            <button class="edit-button" id="open-modal-btn">ä¿®æ”¹ä¸ªäººä¿¡æ¯</button>
            <div class="profile-header">
                <div class="profile-avatar">
                    <img
                         th:src="${session.newBeeMallUser.avatar != null and session.newBeeMallUser.avatar != ''}? ${session.newBeeMallUser.avatar} : '/goods-img/heand.png'">
                </div>
                <div class="profile-details">
                    <div class="profile-info">
                        <i class="fa-solid fa-at"></i>
                        <span  th:text="'æ˜µç§°:'+${session.newBeeMallUser.nickName}">æ˜µç§°: å°æ˜</span>
                    </div>
                    <div class="profile-info">
                        <i class="fa-solid fa-mobile-screen-button"></i>
                        <span th:text="'ç”µè¯å·ç :'+${session.newBeeMallUser.loginName}">ç”µè¯å·ç : 138xxxxxxxx</span>
                    </div>
                    <div class="profile-info">
                        <i class="fa-solid fa-coins"></i>
                        <span th:text="'ä½™é¢:'+${session.newBeeMallUser.balance}+'.00å…ƒ'" style="color: red;font-size: 20px">ä½™é¢: 1000.00 å…ƒ</span>
                    </div>
                    <div class="profile-info">
                        <i class="fa-solid fa-house"></i>
                        <span  th:text="'åœ°å€:'+${session.newBeeMallUser.address==''?'æ— ':session.newBeeMallUser.address}">åœ°å€: åŒ—äº¬å¸‚æœé˜³åŒº xx è·¯ xx å·</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®¢å•æ¿å— -->
        <div class="order-section">
            <div class="order-header">
                <p class="order-title">æˆ‘çš„è®¢å•</p>
                <a th:href="@{/orders}" class="order-all">å…¨éƒ¨è®¢å• ></a>
            </div>
            <div class="order-status">
                <a th:href="@{/conditionsOrders(orderStatus=0)}" class="order-status-item">
                    <i class="fa-solid fa-hourglass-start"></i>
                    <span>å¾…ä»˜æ¬¾</span>
                </a>
                <a th:href="@{/conditionsOrders(orderStatus=1)}" class="order-status-item">
                    <i class="fa-solid fa-pen-to-square"></i>
                    <span>å·²ä»˜æ¬¾</span>
                </a>
                <a th:href="@{/conditionsOrders(orderStatus=3)}" class="order-status-item">
                    <i class="fa-solid fa-truck-fast"></i>
                    <span>å¾…æ”¶è´§</span>
                </a>
                <a href="##" class="order-status-item">
                    <i class="fa-solid fa-rotate-left"></i>
                    <span>å”®åé€€æ¬¾</span>
                </a>
                <a th:href="@{/conditionsOrders(orderStatus=4)}" class="order-status-item">
                    <i class="fa-solid fa-recycle"></i>
                    <span>äº¤æ˜“æˆåŠŸ</span>
                </a>
            </div>
        </div>
    </div>


    <div id="myModal" class="modal">
        <div class="modal-content" style="margin: 5% auto;">
            <span class="close">&times;</span>
            <form class="personalForm">
                <div class="avatar-container">
                    <img id="avatar" class="avatar" th:src="${session.newBeeMallUser.avatar != null and session.newBeeMallUser.avatar != ''}? ${session.newBeeMallUser.avatar} : '/goods-img/heand.png'" alt="Avatar">
                    <input type="file" id="avatar-upload" name="avatar" style="display: none;">
                </div>
                <label for="nickname"><i class="fa-solid fa-user"></i> æ˜µç§°:</label>
                <input type="hidden" id="userId" th:value="${session.newBeeMallUser.userId}">
                <input type="text" id="nickname" name="nickname" th:value="${session.newBeeMallUser.nickName}" placeholder="è¯·è¾“å…¥æ˜µç§°">
                <label for="phone"><i class="fa-solid fa-phone"></i> ç”µè¯å·ç :</label>
                <input type="tel" id="phone" name="phone" th:value="${session.newBeeMallUser.loginName}" placeholder="è¯·è¾“å…¥ç”µè¯å·ç ">
                <label for="password"><i class="fa-solid fa-lock"></i> å¯†ç :</label>
                <input type="text" id="password" name="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                <label for="address"><i class="fa-solid fa-location-dot"></i> åœ°å€:</label>
                <input type="text" id="address" name="address" placeholder="è¯·è¾“å…¥åœ°å€">
                <div class="button-container">
                    <button type="button" id="cancel-btn">å–æ¶ˆ</button>
                    <button type="button" id="confirm-btn">ç¡®è®¤</button>
                </div>
            </form>
        </div>
    </div>
    <!-- å›ºå®šåœ¨å·¦è¾¹çš„å……å€¼æŒ‰é’® -->
    <div class="fixed-recharge-btn">
        <span class="close-btn">&times;</span>
        ç«‹å³å……å€¼ï¼Œç•…äº«ç¦åˆ©ï¼
    </div>

    <!-- å……å€¼å¼¹çª— -->
    <div id="recharge-modal" class="modal">
        <div class="modal-content">
            <span class="close02">&times;</span>
            <h2>å¼€å¯å……å€¼ä¹‹æ—…</h2>
            <form>
                <div class="form-group">
                    <label for="recharge-amount">å……å€¼é‡‘é¢ï¼š</label>
                    <input type="number" id="recharge-amount" name="recharge-amount" min="0" placeholder="è¯·è¾“å…¥å……å€¼é‡‘é¢">
                </div>
                <div>
                    <button type="button" id="cancel-btn02">å–æ¶ˆ</button>
                    <button type="button" id="confirm-btn02">ç¡®è®¤å……å€¼</button>
                </div>
            </form>
        </div>
    </div>

<!--    <div id="myModaltc" class="modaltc">-->
<!--        <div class="modaltc-content">-->
<!--            <span class="closetc">&times;</span>-->
<!--            <div class="success-icon">ğŸ‰</div>-->
<!--            <div class="message" id="message"></div>-->
<!--            <button class="ok-button" onclick="closeModal()">ç¡®å®š</button>-->
<!--        </div>-->
<!--    </div>-->
</div>

<div th:replace="mall/footer::footer-fragment"></div>

<!-- jQuery -->
<script th:src="@{/admin/plugins/jquery/jquery.min.js}"></script>
<script th:src="@{/admin/dist/js/public.js}"></script>
<!-- Bootstrap 3 -->
<script th:src="@{/mall/js/bootstrap3.js}"></script>
<script th:src="@{/mall/js/search.js}" type="text/javascript"></script>
<script th:src="@{/admin/plugins/sweetalert/sweetalert.min.js}"></script>
<script type="text/javascript">

    const modal = document.getElementById('myModal');
    const openModalBtn = document.getElementById('open-modal-btn');
    const closeModalBtn = document.querySelector('.close');
    const cancelBtn = document.getElementById('cancel-btn');
    const confirmBtn = document.getElementById('confirm-btn');
    const avatar = document.getElementById('avatar');
    const avatarUpload = document.getElementById('avatar-upload');
    const srcValue = avatar.getAttribute('src');

    // è·å–å…ƒç´ 
    const fixedRechargeBtn = document.querySelector('.fixed-recharge-btn');
    const closeFixedBtn = document.querySelector('.close-btn');
    const modal02 = document.getElementById('recharge-modal');
    const closeModalBtn02 = document.querySelector('.close02');
    const cancelBtn02 = document.getElementById('cancel-btn02');
    const confirmBtn02 = document.getElementById('confirm-btn02');


    openModalBtn.onclick = function () {
        modal.style.display = "block";
    }

    closeModalBtn.onclick = function () {
        modal.style.display = "none";
    }

    cancelBtn.onclick = function () {
        modal.style.display = "none";
    }

    avatar.onclick = function () {
        avatarUpload.click();
    }

    avatarUpload.onchange = function () {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                avatar.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    }

    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    //ç»‘å®šmodalä¸Šçš„ä¿å­˜æŒ‰é’®
    $('#confirm-btn').click(function () {
        const file = avatarUpload.files[0];
        var avatarImg;
        //var avatar=file.name!=null?"/goods-img/avatar/"+file.name:srcValue;
        if (file) {
            avatarImg="/goods-img/avatar/"+file.name;
        }else {
            avatarImg=srcValue;
        }
        var address = $("#address").val();
        if (address.trim().length < 10) {
            swal("è¯·è¾“å…¥æ­£ç¡®çš„æ”¶è´§ä¿¡æ¯", {
                icon: "error",
            });
            return;
        }
        var nickName = $("#nickname").val();
        if (nickName.trim().length < 2) {
            swal("è¯·è¾“å…¥æ­£ç¡®çš„æ˜µç§°", {
                icon: "error",
            });
            return;
        }
        var phone = $("#phone").val();
        if (!validPhoneNumber(phone)) {
            swal("è¯·è¾“å…¥æ­£ç¡®çš„ç”µè¯å·ç ", {
                icon: "error",
            });
            return;
        }
        var password = $("#password").val();
        if (password.trim().length < 6) {
            swal("è¯·è¾“å…¥æ­£ç¡®çš„å¯†ç ", {
                icon: "error",
            });
            return;
        }
        var userId = $("#userId").val();
        var data = {
            "userId": userId,
            "address": address,
            "avatar":avatarImg,
            "loginName": phone,
            "passwordMd5": password,
            "nickName": nickName
        };
        $.ajax({
            type: 'POST',//æ–¹æ³•ç±»å‹
            url: '/personal/updateInfo',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (result) {
                if (result.resultCode == 200) {
                    modal.style.display = "none";
                    window.location.reload();
                } else {
                    alert(result.message);
                }
                ;
            },
            error: function () {
                alert('æ“ä½œå¤±è´¥');
            }
        });
    });


    // æ‰“å¼€å¼¹çª—
    fixedRechargeBtn.addEventListener('click', function () {
        modal02.style.display = 'block';
    });

    // å…³é—­å›ºå®šæŒ‰é’®
    closeFixedBtn.addEventListener('click', function () {
        modal02.style.display = 'none'
        fixedRechargeBtn.style.display = 'none';
        event.stopPropagation()
    });

    // å…³é—­å¼¹çª—
    closeModalBtn02.addEventListener('click', function () {
        modal02.style.display = 'none';
    });

    // ç‚¹å‡»å–æ¶ˆæŒ‰é’®å…³é—­å¼¹çª—
    cancelBtn02.addEventListener('click', function () {
        modal02.style.display = 'none';
    });
    // console.log(userId, address, password, nickName,srcValue)
    var balanceId = $("#userId").val();
    // console.log(balanceId)

    let amount = 100;
    let modaltc = document.getElementById('myModaltc');
    let messageElement = document.getElementById('message');
    messageElement.textContent = `ä½ å·²æˆåŠŸå……å€¼ ${amount} å…ƒï¼`;
    modaltc.style.display = 'block';

    function closeModal() {
        modaltc.style.display = 'none';
    }

    let closeButton = document.getElementsByClassName("close")[0];
    closeButton.onclick = function () {
        closeModal();
    };

    window.onclick = function (event) {
        if (event.target == modaltc) {
            closeModal();
        }
    };

    // ç‚¹å‡»ç¡®è®¤æŒ‰é’®ï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ å……å€¼é€»è¾‘
    confirmBtn02.addEventListener('click', function () {
        const amount = document.getElementById('recharge-amount').value;
        var data = {
            "userId": balanceId,
            "balance":amount
        };
        if (amount > 0) {
            $.ajax({
                type: 'POST',//æ–¹æ³•ç±»å‹
                url: '/personal/updateBalance',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (result) {
                    if (result.resultCode == 200) {
                        // $('#personalInfoModal').modal('hide');
                        alert(`ä½ å·²æˆåŠŸå……å€¼ ${amount} å…ƒï¼`);
                        modal02.style.display = 'none';
                        window.location.reload();
                    } else {
                        // $('#personalInfoModal').modal('hide');
                        alert(result.message);
                    }
                    ;
                },
                error: function () {
                    alert('æ“ä½œå¤±è´¥');
                }
            });

        } else {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å……å€¼é‡‘é¢ï¼');
        }
    });

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­å¼¹çª—
    window.addEventListener('click', function (event) {
        if (event.target === modal) {
            modal02.style.display = 'none';
        }
    });
</script>
</body>
</html>